{% extends "base.html" %}
{% block title %}Bank Statement Converter - Dashboard{% endblock %}
{% block content %}

<div class="container-fluid" style="margin-top: 80px;">
    <div class="row">
        <div class="col-lg-3 col-md-4">
            <div class="card" style="border-radius: 12px; box-shadow: 0 5px 15px rgba(124, 77, 255, 0.1);">
                <div class="card-body">
                    <h5 class="card-title" style="color: var(--primary-dark); font-weight: 600; margin-bottom: 20px;">Utility</h5>
                    
                    <div class="list-group list-group-flush" id="sidebar-menu">
                        <a href="#pdf2qbo" class="list-group-item list-group-item-action active d-flex align-items-center" onclick="switchTab('pdf2qbo', this)">
                            <i class="fas fa-file-pdf me-3" style="color: var(--primary);"></i>
                            <span>PDF to QBO Conversion</span>
                        </a>
                        <a href="#ai-categorizer" class="list-group-item list-group-item-action d-flex align-items-center" onclick="switchTab('ai-categorizer', this)">
                            <i class="fas fa-brain me-3" style="color: var(--primary);"></i>
                            <span>AI Categorizer (CSV)</span>
                        </a>
                        <a href="#batch-processing" class="list-group-item list-group-item-action d-flex align-items-center" onclick="switchTab('batch-processing', this)">
                            <i class="fas fa-tasks me-3" style="color: var(--primary);"></i>
                            <span>Batch Processing</span>
                        </a>
                        <a href="#quickbooks" class="list-group-item list-group-item-action d-flex align-items-center disabled" onclick="switchTab('quickbooks', this)">
                            <i class="fas fa-plug me-3" style="color: var(--primary);"></i>
                            <span>Quickbook API Integration</span>
                        </a>
                    </div>
                    
                    <div class="mt-4 pt-3 border-top">
                        <div class="d-flex align-items-center">
                            <div style="width: 40px; height: 40px; background-color: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                {{ session.get('user_name', 'U')[0] }}
                            </div>
                            <div class="ms-3">
                                <div style="font-weight: 600;">{{ session.get('user_name', 'User') }}</div>
                                <div style="font-size: 0.8rem; color: var(--text-light);">
                                    {{ session.get('plan_name', 'Paid Plan') }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-9 col-md-8">
            <div id="pdf2qbo" class="content-tab active">
                <div class="card" style="border-radius: 12px; box-shadow: 0 5px 15px rgba(124, 77, 255, 0.1);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 style="color: var(--primary-dark); font-weight: 700;">PDF to QBO Conversion</h2>
                            <div class="btn-group" role="group">
                                <button class="btn cta-button" onclick="document.getElementById('pdfFile').click()">
                                    <i class="fas fa-plus me-2"></i> Convert PDF
                                </button>
                                <button class="btn btn-outline-primary" onclick="refreshConversions()">
                                    <i class="fas fa-sync me-2"></i> Refresh
                                </button>
                            </div>
                        </div>
                        
                        <form id="pdfUploadForm" enctype="multipart/form-data" class="mb-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="file" id="pdfFile" name="file" accept=".pdf" class="form-control" style="display: none;" onchange="handleFileSelect(this)">
                                    <div class="input-group">
                                        <input type="text" id="fileDisplay" class="form-control" placeholder="No file selected" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('pdfFile').click()">
                                            <i class="fas fa-folder-open"></i> Browse
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn cta-button w-100" onclick="convertPdfToQbo()">
                                        <i class="fas fa-exchange-alt me-2"></i> Convert to QBO
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <div id="conversionProgress" class="mb-4" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="text-center mt-2">
                                <small id="progressText">Processing...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="ai-categorizer" class="content-tab" style="display: none;">
                <div class="card" style="border-radius: 12px; box-shadow: 0 5px 15px rgba(124, 77, 255, 0.1);">
                    <div class="card-body">
                        <h2 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 30px;">AI Categorizer (CSV)</h2>
                        
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="fas fa-info-circle me-3"></i>
                            <div>
                                Upload a CSV file with transaction data to automatically categorize transactions using AI.
                            </div>
                        </div>
                        
                        <form id="csvUploadForm" enctype="multipart/form-data" class="mb-4">
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">Select CSV File</label>
                                <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" onchange="handleCsvFileSelect(this)">
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="descriptionColumn" class="form-label">Description Column</label>
                                        <select class="form-select" id="descriptionColumn" name="description_column">
                                            <option value="">Auto-detect</option>
                                            <option value="description">Description</option>
                                            <option value="memo">Memo</option>
                                            <option value="payee">Payee</option>
                                            <option value="merchant">Merchant</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="amountColumn" class="form-label">Amount Column</label>
                                        <select class="form-select" id="amountColumn" name="amount_column">
                                            <option value="">Auto-detect</option>
                                            <option value="amount">Amount</option>
                                            <option value="total">Total</option>
                                            <option value="value">Value</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" class="btn cta-button" onclick="categorizeTransactions()">
                                <i class="fas fa-brain me-2"></i> Categorize Transactions
                            </button>
                        </form>
                        
                        <div id="categorizationProgress" class="mb-4" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="text-center mt-2">
                                <small id="categorizationProgressText">Analyzing transactions...</small>
                            </div>
                        </div>
                        
                        <div id="categorizationResults" style="display: none;">
                            <h5 class="mb-3">Categorization Results</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Predicted Category</th>
                                            <th>Confidence</th>
                                        </tr>
                                    </thead>
                                    <tbody id="categorizationResultsTable">
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-outline-primary" onclick="downloadCategorizedCsv()">
                                    <i class="fas fa-download me-2"></i> Download Categorized CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="batch-processing" class="content-tab" style="display: none;">
                <div class="card" style="border-radius: 12px; box-shadow: 0 5px 15px rgba(124, 77, 255, 0.1);">
                    <div class="card-body">
                        <h2 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 30px;">Batch Processing</h2>
                        
                        <div class="alert alert-warning d-flex align-items-center" role="alert">
                            <i class="fas fa-exclamation-triangle me-3"></i>
                            <div>
                                Upload multiple PDF files (max 10 files, 16MB total) for batch conversion to QBO format.
                            </div>
                        </div>
                        
                        <form id="batchUploadForm" enctype="multipart/form-data" class="mb-4">
                            <div class="mb-3">
                                <label for="batchFiles" class="form-label">Select PDF Files</label>
                                <input type="file" class="form-control" id="batchFiles" name="files" accept=".pdf" multiple onchange="handleBatchFileSelect(this)">
                                <div class="form-text">Select up to 10 PDF files. Each file will be converted to its own QBO file.</div>
                            </div>
                            
                            <div id="selectedFiles" class="mb-3" style="display: none;">
                                <h6>Selected Files:</h6>
                                <div id="fileList" class="list-group">
                                </div>
                            </div>
                            
                            <button type="button" class="btn cta-button" onclick="startBatchProcessing()">
                                <i class="fas fa-cogs me-2"></i> Start Batch Processing
                            </button>
                        </form>
                        
                        <div id="activeJobs" class="mb-4">
                            <h5 class="mb-3">Active Jobs</h5>
                            <div id="jobsList">
                                <div class="text-center text-muted">
                                    <i class="fas fa-tasks fa-2x mb-2"></i>
                                    <p>No active batch jobs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="quickbooks" class="content-tab" style="display: none;">
                <div class="card" style="border-radius: 12px; box-shadow: 0 5px 15px rgba(124, 77, 255, 0.1);">
                    <div class="card-body">
                        <h2 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 30px;">Quickbook API Integration</h2>
                        
                        <div class="alert alert-secondary d-flex align-items-center" role="alert">
                            <i class="fas fa-clock me-3"></i>
                            <div>
                                This feature is currently under development and will be available soon.
                            </div>
                        </div>
                        
                        <div class="text-center py-5 my-3 border rounded" style="background-color: #f8f9fa;">
                            <i class="fab fa-quickbooks fa-4x mb-3" style="color: var(--primary-light);"></i>
                            <h4>Coming Soon</h4>
                            <p class="text-muted">Direct QuickBooks integration will be available in the next update</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced Dashboard JavaScript with API Integration

// Global variables
let activeJobs = {};
let refreshInterval = null;
let categorizedData = []; // To store categorized CSV data for download

function getCSRFToken() {
    const token = document.querySelector('meta[name=csrf-token]');
    return token ? token.getAttribute('content') : null;
}

function validateFile(file, maxSize = 10 * 1024 * 1024) { // Default 10MB
    if (!file) {
        showToast('No file selected', 'error');
        return false;
    }
    
    if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
        showToast('Please select a valid PDF file', 'error');
        return false;
    }
    
    if (file.size > maxSize) {
        showToast(`File size must be less than ${formatFileSize(maxSize)}`, 'error');
        return false;
    }
    
    if (file.size === 0) {
        showToast('Selected file is empty', 'error');
        return false;
    }
    
    return true;
}

function validateCsvFile(file, maxSize = 16 * 1024 * 1024) { // 16MB for CSV
    if (!file) {
        showToast('No file selected', 'error');
        return false;
    }
    
    // Check file type for CSV
    if (file.type !== 'text/csv' && !file.name.toLowerCase().endsWith('.csv')) {
        showToast('Please select a valid CSV file', 'error');
        return false;
    }
    
    // Check file size
    if (file.size > maxSize) {
        showToast(`File size must be less than ${formatFileSize(maxSize)}`, 'error');
        return false;
    }
    
    if (file.size === 0) {
        showToast('Selected file is empty', 'error');
        return false;
    }
    
    return true;
}

async function handleResponse(response) {
    if (!response.ok) {
        let errorData;
        const contentType = response.headers.get('content-type');
        
        try {
            if (contentType && contentType.includes('application/json')) {
                errorData = await response.json();
            } else {
                const errorText = await response.text();
                errorData = { error: errorText || `HTTP ${response.status}` };
            }
        } catch (parseError) {
            errorData = { error: `HTTP ${response.status}: ${response.statusText}` };
        }
        
        console.error('Backend error:', {
            status: response.status,
            statusText: response.statusText,
            error: errorData
        });
        
        throw new Error(errorData.error || `Server error: ${response.status}`);
    }
    
    return response;
}

// Utility functions
function showToast(message, type = 'info') {
    const toastContainer = document.createElement('div');
    toastContainer.className = `toast-container position-fixed top-0 end-0 p-3`;
    toastContainer.style.zIndex = '9999';
    
    const toast = document.createElement('div');
    toast.className = `toast show align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    document.body.appendChild(toastContainer);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (document.body.contains(toastContainer)) {
            document.body.removeChild(toastContainer);
        }
    }, 5000);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        return new Date(dateString).toLocaleString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateString; // Return original if parsing fails
    }
}

// Tab switching functionality
function switchTab(tabId, linkElement) {
    // Hide all content tabs
    document.querySelectorAll('.content-tab').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Show the selected tab
    document.getElementById(tabId).style.display = 'block';
    
    // Update active state in sidebar
    document.querySelectorAll('#sidebar-menu .list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    linkElement.classList.add('active');
    
    // Start/stop batch job polling based on active tab
    if (tabId === 'batch-processing') {
        startBatchJobPolling();
    } else {
        stopBatchJobPolling();
    }

    // Refresh PDF2QBO table when switching back to it
    if (tabId === 'pdf2qbo') {
        refreshConversions();
    }
}

// File selection handlers
function handleFileSelect(input) {
    const fileDisplay = document.getElementById('fileDisplay');
    if (input.files && input.files[0]) {
        fileDisplay.value = input.files[0].name;
    } else {
        fileDisplay.value = 'No file selected';
    }
}

function handleCsvFileSelect(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        if (!validateCsvFile(file)) {
            input.value = '';
            return;
        }
        
        // Try to detect columns from CSV header
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const csv = e.target.result;
                const lines = csv.split('\n');
                if (lines.length > 0) {
                    const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));
                    populateColumnOptions(headers);
                }
            } catch (error) {
                console.error('Error reading CSV headers:', error);
                showToast('Could not read CSV headers', 'error');
            }
        };
        
        reader.onerror = function() {
            showToast('Error reading file', 'error');
        };
        
        reader.readAsText(file.slice(0, 1024)); // Read first 1KB to get headers
    }
}

function populateColumnOptions(headers) {
    const descriptionSelect = document.getElementById('descriptionColumn');
    const amountSelect = document.getElementById('amountColumn');
    
    // Clear existing options except first one (Auto-detect)
    [descriptionSelect, amountSelect].forEach(select => {
        while (select.options.length > 1) {
            select.remove(1);
        }
    });
    
    // Add header options
    headers.forEach(header => {
        const option1 = new Option(header, header);
        const option2 = new Option(header, header);
        descriptionSelect.add(option1);
        amountSelect.add(option2);
    });
    
    // Auto-select likely columns
    headers.forEach(header => {
        const lowerHeader = header.toLowerCase();
        if (lowerHeader.includes('description') || lowerHeader.includes('memo') || lowerHeader.includes('payee') || lowerHeader.includes('narrative')) {
            descriptionSelect.value = header;
        }
        if (lowerHeader.includes('amount') || lowerHeader.includes('total') || lowerHeader.includes('value') || lowerHeader.includes('debit') || lowerHeader.includes('credit')) {
            // This is a simplified auto-detect. For real-world, you might need more complex logic
            // especially if debit/credit are separate columns.
            amountSelect.value = header;
        }
    });
}

function handleBatchFileSelect(input) {
    const selectedFilesDiv = document.getElementById('selectedFiles');
    const fileListDiv = document.getElementById('fileList');
    
    if (input.files && input.files.length > 0) {
        const files = Array.from(input.files);
        
        // Validate file count
        if (files.length > 10) {
            showToast('Maximum 10 files allowed for batch processing', 'error');
            input.value = '';
            fileListDiv.innerHTML = '';
            selectedFilesDiv.style.display = 'none';
            return;
        }
        
        // Validate each file and calculate total size
        let totalSize = 0;
        let allFilesValid = true;
        fileListDiv.innerHTML = ''; // Clear previous list
        
        files.forEach(file => {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showToast(`File "${file.name}" is not a PDF and will be skipped.`, 'error');
                allFilesValid = false;
                return; // Skip this file, but continue checking others
            }
            
            if (file.size === 0) {
                showToast(`File "${file.name}" is empty and will be skipped.`, 'error');
                allFilesValid = false;
                return; // Skip this file
            }
            
            totalSize += file.size;
            
            const fileItem = document.createElement('div');
            fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            fileItem.innerHTML = `
                <span><i class="fas fa-file-pdf me-2 text-danger"></i>${file.name}</span>
                <span class="badge bg-secondary">${formatFileSize(file.size)}</span>
            `;
            fileListDiv.appendChild(fileItem);
        });

        if (!allFilesValid) {
            input.value = ''; // Clear invalid files from input
            selectedFilesDiv.style.display = 'none';
            return;
        }
        
        if (totalSize > 16 * 1024 * 1024) { // 16 MB limit
            showToast('Total file size must be less than 16MB', 'error');
            input.value = '';
            fileListDiv.innerHTML = '';
            selectedFilesDiv.style.display = 'none';
            return;
        }
        
        // Display selected files
        selectedFilesDiv.style.display = 'block';
        
        // Show total size
        const totalSizeItem = document.createElement('div');
        totalSizeItem.className = 'list-group-item bg-light';
        totalSizeItem.innerHTML = `
            <strong>Total Size: ${formatFileSize(totalSize)}</strong>
        `;
        fileListDiv.appendChild(totalSizeItem);
        
    } else {
        selectedFilesDiv.style.display = 'none';
        fileListDiv.innerHTML = '';
    }
}

// Progress bar utilities
function showProgress(progressId, textId) {
    const progressDiv = document.getElementById(progressId);
    const progressBar = progressDiv.querySelector('.progress-bar');
    const progressText = document.getElementById(textId);
    
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = 'Starting...';
}

function updateProgress(progressId, textId, percent, text) {
    const progressDiv = document.getElementById(progressId);
    const progressBar = progressDiv.querySelector('.progress-bar');
    const progressText = document.getElementById(textId);
    
    if (progressDiv.style.display === 'none') { // Ensure it's visible if updating from hidden state
        progressDiv.style.display = 'block';
    }
    progressBar.style.width = `${percent}%`;
    progressBar.setAttribute('aria-valuenow', percent);
    progressText.textContent = text;
}

function hideProgress(progressId) {
    const progressDiv = document.getElementById(progressId);
    progressDiv.style.display = 'none';
}

// PDF to QBO Conversion
async function convertPdfToQbo() {
    const fileInput = document.getElementById('pdfFile');
    const file = fileInput.files[0];
    
    if (!validateFile(file)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file, file.name);
    
    showProgress('conversionProgress', 'progressText');
    updateProgress('conversionProgress', 'progressText', 10, 'Uploading PDF...');
    
    try {
        const headers = {};
        const csrfToken = getCSRFToken();
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        
        const response = await fetch('/convert-pdf-to-qbo', {
            method: 'POST',
            headers: headers, // Headers for CSRF, content-type is set automatically by FormData
            body: formData
        });
        
        updateProgress('conversionProgress', 'progressText', 50, 'Processing PDF...');
        
        // Handle potentially non-OK responses
        await handleResponse(response);
        
        updateProgress('conversionProgress', 'progressText', 75, 'Generating QBO file...');
        
        // Handle file download
        const blob = await response.blob();
        // Extract filename from Content-Disposition header if available, otherwise default
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `transactions_${new Date().toISOString().slice(0, 10)}.qbo`;
        if (contentDisposition && contentDisposition.includes('filename=')) {
            filename = contentDisposition.split('filename=')[1].trim().replace(/['"]/g, '');
        }

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        updateProgress('conversionProgress', 'progressText', 100, 'Download complete!');
        showToast('PDF converted to QBO successfully!', 'success');
        
        // Clear file input
        fileInput.value = '';
        document.getElementById('fileDisplay').value = 'No file selected';
        
        // Refresh conversions table after a short delay
        setTimeout(refreshConversions, 1000);
        
    } catch (error) {
        console.error('Conversion error:', error);
        showToast(error.message || 'Conversion failed. Please try again.', 'error');
    } finally {
        hideProgress('conversionProgress');
    }
}

/**
 * @function refreshConversions
 * @description Fetches and displays recent PDF to QBO conversion history from the backend.
 */
async function refreshConversions() {
    const conversionsTableBody = document.getElementById('conversionsTable');
    conversionsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin me-2"></i>Loading conversions...</td></tr>`;

    try {
        
        const response = await fetch('/api/conversions', { method: 'GET' });
        await handleResponse(response);
        const data = await response.json(); // Assuming backend returns JSON

        const simulatedData = [
            { id: 'c1', fileName: 'bank_statement_april.pdf', date: new Date().toISOString(), status: 'Complete', transactions: 62, downloadUrl: '/download/c1' },
            { id: 'c2', fileName: 'credit_card_may.pdf', date: new Date(Date.now() - 86400000).toISOString(), status: 'Complete', transactions: 91, downloadUrl: '/download/c2' },
            { id: 'c3', fileName: 'payroll_june.pdf', date: new Date(Date.now() - 2 * 86400000).toISOString(), status: 'Failed', transactions: 0, downloadUrl: null, error: 'File corrupted' },
            { id: 'c4', fileName: 'utility_bills_july.pdf', date: new Date(Date.now() - 3 * 86400000).toISOString(), status: 'Processing', transactions: null, downloadUrl: null },
        ];
        // For the purpose of this demo, let's use the simulated data instead of the actual fetch result
        // In your real app, use `const conversions = data;`
        const conversions = data.length > 0 ? data : simulatedData; 
        // --- END SIMULATED DATA ---

        conversionsTableBody.innerHTML = ''; // Clear loading message

        if (conversions.length === 0) {
            conversionsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">No recent conversions found.</td></tr>`;
            return;
        }

        conversions.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending

        conversions.forEach(conv => {
            const statusBadge = conv.status === 'Complete' ? 'bg-success' :
                                conv.status === 'Processing' ? 'bg-info' :
                                'bg-danger';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${conv.fileName}</td>
                <td>${formatDate(conv.date)}</td>
                <td><span class="badge ${statusBadge}">${conv.status}</span></td>
                <td>${conv.transactions !== null ? conv.transactions : 'N/A'}</td>
                <td>
                    ${conv.status === 'Complete' ? `
                        <button class="btn btn-sm btn-outline-primary me-1" title="Download QBO" onclick="downloadQBO('${conv.downloadUrl}', '${conv.fileName.replace('.pdf', '.qbo')}')"><i class="fas fa-download"></i></button>
                    ` : `<button class="btn btn-sm btn-outline-primary me-1" title="Download QBO" disabled><i class="fas fa-download"></i></button>`}
                    <button class="btn btn-sm btn-outline-secondary" title="View Details" disabled><i class="fas fa-eye"></i></button>
                </td>
            `;
            conversionsTableBody.appendChild(row);
        });

    } catch (error) {
        console.error('Error fetching conversions:', error);
        conversionsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-3"><i class="fas fa-exclamation-circle me-2"></i>Failed to load conversions.</td></tr>`;
        showToast(error.message || 'Failed to load conversion history.', 'error');
    }
}

function downloadQBO(url, filename) {
    if (!url) {
        showToast('No download link available for this file.', 'error');
        return;
    }
    // For simplicity, directly opening the URL. For secure downloads, use fetch and blob.
    window.open(url, '_blank');
    showToast(`Downloading ${filename}...`, 'info');
}

// AI Categorizer functionality
async function categorizeTransactions() {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];
    
    if (!validateCsvFile(file)) {
        return;
    }
    
    const descriptionColumn = document.getElementById('descriptionColumn').value;
    const amountColumn = document.getElementById('amountColumn').value;
    
    const formData = new FormData();
    formData.append('file', file, file.name);
    
    if (descriptionColumn) {
        formData.append('description_column', descriptionColumn);
    }
    if (amountColumn) {
        formData.append('amount_column', amountColumn);
    }
    
    showProgress('categorizationProgress', 'categorizationProgressText');
    updateProgress('categorizationProgress', 'categorizationProgressText', 10, 'Uploading CSV...');
    
    try {
        const headers = {};
        const csrfToken = getCSRFToken();
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        const response = await fetch('/api/categorize-csv', { // Assumed backend endpoint
            method: 'POST',
            headers: headers,
            body: formData
        });

        updateProgress('categorizationProgress', 'categorizationProgressText', 50, 'Analyzing transactions with AI...');
        
        await handleResponse(response);
        
        categorizedData = await response.json(); // Store the data for download
        
        updateProgress('categorizationProgress', 'categorizationProgressText', 90, 'Displaying results...');

        const resultsTableBody = document.getElementById('categorizationResultsTable');
        resultsTableBody.innerHTML = ''; // Clear previous results

        if (categorizedData.length === 0) {
            resultsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">No transactions categorized.</td></tr>`;
        } else {
            categorizedData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.description || 'N/A'}</td>
                    <td>${item.amount !== undefined ? parseFloat(item.amount).toFixed(2) : 'N/A'}</td>
                    <td><span class="badge bg-primary">${item.predicted_category || 'Uncategorized'}</span></td>
                    <td>${item.confidence !== undefined ? (item.confidence * 100).toFixed(1) + '%' : 'N/A'}</td>
                `;
                resultsTableBody.appendChild(row);
            });
        }
        
        document.getElementById('categorizationResults').style.display = 'block';
        updateProgress('categorizationProgress', 'categorizationProgressText', 100, 'Categorization complete!');
        showToast('Transactions categorized successfully!', 'success');

    } catch (error) {
        console.error('Categorization error:', error);
        showToast(error.message || 'Categorization failed. Please check your CSV and try again.', 'error');
        document.getElementById('categorizationResults').style.display = 'none'; // Hide results on error
    } finally {
        hideProgress('categorizationProgress');
    }
}

/**
 * @function downloadCategorizedCsv
 * @description Creates a CSV from the categorized data and prompts for download.
 */
function downloadCategorizedCsv() {
    if (categorizedData.length === 0) {
        showToast('No categorized data to download.', 'info');
        return;
    }

    // Define CSV headers (customize as needed)
    const headers = ['Description', 'Amount', 'Predicted Category', 'Confidence'];
    
    // Map data to CSV rows
    const csvRows = [
        headers.join(','), // Add header row
        ...categorizedData.map(item => {
            // Escape commas and double quotes in fields
            const escapeCsvField = (field) => {
                if (typeof field === 'string' && (field.includes(',') || field.includes('"'))) {
                    return `"${field.replace(/"/g, '""')}"`;
                }
                return field;
            };

            return [
                escapeCsvField(item.description),
                item.amount !== undefined ? parseFloat(item.amount).toFixed(2) : '',
                escapeCsvField(item.predicted_category),
                item.confidence !== undefined ? (item.confidence * 100).toFixed(1) + '%' : ''
            ].join(',');
        })
    ];

    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `categorized_transactions_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Categorized CSV downloaded!', 'success');
}


// Batch Processing Functions
/**
 * @function startBatchProcessing
 * @description Initiates the upload and conversion of multiple PDF files.
 */
async function startBatchProcessing() {
    const fileInput = document.getElementById('batchFiles');
    const files = Array.from(fileInput.files);

    if (files.length === 0) {
        showToast('Please select files for batch processing.', 'error');
        return;
    }

    // Clear previous jobs list and show loading
    const jobsListDiv = document.getElementById('jobsList');
    jobsListDiv.innerHTML = `<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin me-2"></i>Starting batch jobs...</div>`;
    activeJobs = {}; // Reset active jobs

    const formData = new FormData();
    files.forEach(file => {
        if (file.name.toLowerCase().endsWith('.pdf') && file.size > 0) { // Re-validate, just in case
            formData.append('files', file, file.name);
        }
    });

    if (formData.getAll('files').length === 0) {
        showToast('No valid PDF files selected for processing.', 'error');
        jobsListDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-tasks fa-2x mb-2"></i><p>No active batch jobs</p></div>`;
        return;
    }

    showToast('Starting batch processing...', 'info');

    try {
        const headers = {};
        const csrfToken = getCSRFToken();
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        const response = await fetch('/batch-convert-pdf-to-qbo', { 
            method: 'POST',
            headers: headers,
            body: formData
        });

        await handleResponse(response);
        const jobResponse = await response.json(); // Expects an array of { jobId: 'uuid', fileName: 'name.pdf', status: 'Pending' }

        if (jobResponse && jobResponse.length > 0) {
            jobsListDiv.innerHTML = ''; // Clear "Starting batch jobs..."
            jobResponse.forEach(job => {
                activeJobs[job.jobId] = { ...job, progress: 0 }; // Initialize progress
                addBatchJobToUI(job.jobId, job.fileName, 'Pending', 0);
            });
            showToast('Batch processing initiated successfully!', 'success');
            startBatchJobPolling(); // Start polling for status updates
        } else {
            showToast('No batch jobs were created by the server.', 'warning');
            jobsListDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-tasks fa-2x mb-2"></i><p>No active batch jobs</p></div>`;
        }

    } catch (error) {
        console.error('Batch processing initiation error:', error);
        showToast(error.message || 'Failed to start batch processing.', 'error');
        jobsListDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-tasks fa-2x mb-2"></i><p>No active batch jobs</p></div>`;
    } finally {
        // Clear the file input after submission
        fileInput.value = '';
        document.getElementById('selectedFiles').style.display = 'none';
        document.getElementById('fileList').innerHTML = '';
    }
}

/**
 * @function addBatchJobToUI
 * @description Adds a new batch job entry to the UI.
 * @param {string} jobId - The ID of the batch job.
 * @param {string} fileName - The name of the file being processed.
 * @param {string} status - The initial status (e.g., 'Pending').
 * @param {number} progress - The initial progress percentage.
 */
function addBatchJobToUI(jobId, fileName, status, progress) {
    const jobsListDiv = document.getElementById('jobsList');
    // If "No active batch jobs" message is present, remove it
    if (jobsListDiv.querySelector('.text-muted p') && jobsListDiv.querySelector('.text-muted p').textContent === 'No active batch jobs') {
        jobsListDiv.innerHTML = '';
    }

    const jobElement = document.createElement('div');
    jobElement.id = `job-${jobId}`;
    jobElement.className = 'list-group-item d-flex flex-column mb-2 border rounded p-3';
    jobElement.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span><i class="fas fa-file-pdf me-2 text-primary"></i><strong>${fileName}</strong></span>
            <span id="status-${jobId}" class="badge bg-info">${status}</span>
        </div>
        <div class="progress mb-2">
            <div id="progress-bar-${jobId}" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <small id="progress-text-${jobId}" class="text-muted text-center">${progress}% Complete</small>
        <div id="actions-${jobId}" class="mt-2 text-center" style="display: ${status === 'Complete' ? 'block' : 'none'};">
            <button class="btn btn-sm btn-success me-2" onclick="downloadBatchResult('${jobId}', '${fileName.replace('.pdf', '.qbo')}')"><i class="fas fa-download me-1"></i>Download QBO</button>
            <button class="btn btn-sm btn-outline-danger" onclick="removeJobFromUI('${jobId}')"><i class="fas fa-times me-1"></i>Remove</button>
        </div>
        <div id="error-${jobId}" class="alert alert-danger mt-2 p-2" style="display: none;"></div>
    `;
    jobsListDiv.prepend(jobElement); // Add new jobs to the top
}

/**
 * @function updateBatchJobStatus
 * @description Updates the UI for a specific batch job.
 * @param {string} jobId - The ID of the batch job.
 * @param {object} statusData - Object containing new status, progress, etc.
 */
function updateBatchJobStatus(jobId, statusData) {
    const statusElement = document.getElementById(`status-${jobId}`);
    const progressBar = document.getElementById(`progress-bar-${jobId}`);
    const progressText = document.getElementById(`progress-text-${jobId}`);
    const actionsDiv = document.getElementById(`actions-${jobId}`);
    const errorDiv = document.getElementById(`error-${jobId}`);

    if (!statusElement || !progressBar) return; // Job element might have been removed

    statusElement.textContent = statusData.status;
    progressBar.style.width = `${statusData.progress || 0}%`;
    progressBar.setAttribute('aria-valuenow', statusData.progress || 0);
    progressText.textContent = `${statusData.progress || 0}% Complete - ${statusData.message || ''}`;

    if (statusData.status === 'Complete') {
        statusElement.className = 'badge bg-success';
        progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
        actionsDiv.style.display = 'block';
        showToast(`Batch job for ${activeJobs[jobId].fileName} completed!`, 'success');
        delete activeJobs[jobId]; // Remove from active jobs
    } else if (statusData.status === 'Failed') {
        statusElement.className = 'badge bg-danger';
        progressBar.classList.remove('progress-bar-animated');
        progressBar.style.width = '100%';
        errorDiv.style.display = 'block';
        errorDiv.textContent = `Error: ${statusData.error || 'Unknown error'}`;
        showToast(`Batch job for ${activeJobs[jobId].fileName} failed! ${statusData.error || ''}`, 'error');
        delete activeJobs[jobId]; // Remove from active jobs
    } else { // Processing, Pending, etc.
        statusElement.className = 'badge bg-info';
    }

    // If no more active jobs, show the "No active jobs" message
    if (Object.keys(activeJobs).length === 0 && document.getElementById('jobsList').children.length === 0) {
        document.getElementById('jobsList').innerHTML = `<div class="text-center text-muted"><i class="fas fa-tasks fa-2x mb-2"></i><p>No active batch jobs</p></div>`;
    }
}

/**
 * @function startBatchJobPolling
 * @description Starts an interval to poll for batch job statuses.
 */
function startBatchJobPolling() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
    // Poll every 5 seconds
    refreshInterval = setInterval(async () => {
        if (Object.keys(activeJobs).length === 0) {
            stopBatchJobPolling();
            return;
        }

        for (const jobId in activeJobs) {
            try {
                const response = await fetch(`/api/batch-jobs/${jobId}/status`, { method: 'GET' });
                await handleResponse(response);
                const statusData = await response.json();
                updateBatchJobStatus(jobId, statusData);
            } catch (error) {
                console.error(`Error polling status for job ${jobId}:`, error);
                // Mark job as failed if polling fails repeatedly or with critical error
                updateBatchJobStatus(jobId, { status: 'Failed', progress: 100, error: `Failed to fetch status: ${error.message}` });
            }
        }
    }, 5000); // Poll every 5 seconds
    console.log("Batch job polling started.");
}

/**
 * @function stopBatchJobPolling
 * @description Stops the batch job status polling interval.
 */
function stopBatchJobPolling() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
        console.log("Batch job polling stopped.");
    }
}

/**
 * @function downloadBatchResult
 * @description Triggers the download of a QBO file for a completed batch job.
 * @param {string} jobId - The ID of the completed batch job.
 * @param {string} filename - The original filename to suggest for download.
 */
async function downloadBatchResult(jobId, filename) {
    showToast(`Preparing download for ${filename}...`, 'info');
    try {
        const response = await fetch(`/api/batch-jobs/${jobId}/download`, { method: 'GET' }); // Assumed backend endpoint
        await handleResponse(response);

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename; // Use provided filename for direct download
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        showToast(`Downloaded ${filename}.`, 'success');
    } catch (error) {
        console.error('Error downloading batch result:', error);
        showToast(error.message || 'Failed to download batch file.', 'error');
    }
}

/**
 * @function removeJobFromUI
 * @description Removes a batch job entry from the UI.
 * @param {string} jobId - The ID of the job to remove.
 */
function removeJobFromUI(jobId) {
    const jobElement = document.getElementById(`job-${jobId}`);
    if (jobElement) {
        jobElement.remove();
        delete activeJobs[jobId]; // Ensure it's also removed from tracking

        // If no more active jobs and no visible job elements, show placeholder
        if (Object.keys(activeJobs).length === 0 && document.getElementById('jobsList').children.length === 0) {
            document.getElementById('jobsList').innerHTML = `<div class="text-center text-muted"><i class="fas fa-tasks fa-2x mb-2"></i><p>No active batch jobs</p></div>`;
        }
        showToast('Batch job entry removed.', 'info');
    }
}


// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', () => {
    // Refresh conversions table on initial load for the PDF to QBO tab
    refreshConversions();

    // Ensure only the default active tab is visible on load
    document.querySelectorAll('.content-tab').forEach(tab => {
        if (!tab.classList.contains('active')) {
            tab.style.display = 'none';
        }
    });
});
</script>
{% endblock %}